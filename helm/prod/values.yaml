---
name: prod
replicas: 2
image:
  repository: 182889640030.dkr.ecr.us-east-1.amazonaws.com/ludacris-repo
  tag: latest
  digest: ""
containerPort: 5000
service:
  type: LoadBalancer
  port: 80
  targetPort: 5000
resources:
  limits:
    cpu: 250m
    memory: 256Mi
  requests:
    cpu: 100m
    memory: 128Mi
hpa:
  enabled: true
  minReplicas: 1
  maxReplicas: 5
  targetCPUUtilizationPercentage: 70


prometheusRules: 
  enabled: true
  node:
    enabled: true
    alerts:
      - name: NodeDown
        expr: up{job="node-exporter"} == 0
        for: 2m
        severity: critical
        summary: Node {{`{{ $labels.instance }}`}} is down
        description: Node {{`{{ $labels.instance }}`}} has been unreachable for more
          than 2 minutes.
        impact: Workloads running on this node may be unavailable or rescheduled, causing service disruption.
        action: Check node status in the cloud provider, verify kubelet is running, and inspect node logs.


      - name: NodeHighCPU
        expr: |
          100 - (avg by (instance)(
            rate(node_cpu_seconds_total{mode="idle"}[5m])
          ) * 100) > 85
        for: 5m
        severity: warning
        summary: High CPU on {{`{{ $labels.instance }}`}}
        description: CPU usage is above 85% for 5 minutes.
      - name: NodeHighMemory
        expr: |
          (1 - (
            node_memory_MemAvailable_bytes
            / node_memory_MemTotal_bytes
          )) * 100 > 90
        for: 5m
        severity: warning
        summary: High memory usage on {{`{{ $labels.instance }}`}}
        description: Memory usage is above 90% for 5 minutes.
        impact: Pods may be OOMKilled, leading to application instability.
        action: Inspect memory usage per pod, review limits/requests, and scale or optimize workloads.

      - name: NodeDiskAlmostFull
        expr: |
          (1 - (
            node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"}
            / node_filesystem_size_bytes{fstype!~"tmpfs|overlay"}
          )) * 100 > 85
        for: 10m
        severity: critical
        summary: Disk almost full on {{`{{ $labels.instance }}`}}
        description: Disk usage is above 85%.
        impact: Node may fail to schedule pods or write logs, causing outages.
        action: Clean up unused data, expand disk capacity, or migrate workloads off the node


  pod:
    enabled: true
    alerts:
      - name: PodCrashLooping
        expr: increase(kube_pod_container_status_restarts_total[5m]) > 3
        for: 5m
        severity: warning
        summary: Pod {{`{{ $labels.pod }}`}} is crash looping
        description: Container in pod {{`{{ $labels.pod }}`}} restarted more than 3
          times in 5 minutes.
        impact: The application may be unstable or partially unavailable.
        action: Check pod logs, recent configuration changes, and resource limits.

      - name: PodNotReady
        expr: kube_pod_status_ready{condition="false"} == 1
        for: 3m
        severity: critical
        summary: Pod {{`{{ $labels.pod }}`}} not ready
        description: Pod {{`{{ $labels.pod }}`}} has been not ready for more than 3 minutes.
        impact: Traffic may not be served by this pod, impacting users.
        action: Describe the pod, inspect readiness probes, logs, and node health.

      - name: PodImagePullBackOff
        expr: kube_pod_container_status_waiting_reason{reason="ImagePullBackOff"} == 1
        for: 2m
        severity: critical
        summary: ImagePullBackOff on {{`{{ $labels.pod }}`}}
        description: Container image cannot be pulled.
        impact: The pod cannot start, causing application downtime.
        action: Verify image name/tag, registry availability, and imagePullSecrets.


  deployment:
    enabled: true
    alerts:
      - name: DeploymentReplicasMismatch
        expr: >
          kube_deployment_spec_replicas != kube_deployment_status_replicas_available
        for: 5m
        severity: warning
        summary: Deployment {{`{{ $labels.deployment }}`}} replicas mismatch
        description: Available replicas do not match desired count.
        impact: Reduced capacity may lead to degraded performance.
        action: Check pod status, rollout history, and cluster capacity.


      - name: DeploymentUnavailable
        expr: kube_deployment_status_replicas_available == 0
        for: 2m
        severity: critical
        summary: Deployment {{`{{ $labels.deployment }}`}} is unavailable
        description: No replicas are available for deployment.
        impact: Application is completely unavailable to users.
        action: Inspect deployment events, pod failures, and rollback if necessary.

  monitoring:
    enabled: true
    alerts:
      - name: PrometheusDown
        expr: up{job="prometheus"} == 0
        for: 2m
        severity: critical
        summary: Prometheus is down
        description: Prometheus instance is not reachable.
        impact: Metrics collection and alert evaluation are not functioning..
        action: Check Prometheus pod status, logs, and resource usage.

      - name: AlertmanagerDown
        expr: up{job="alertmanager"} == 0
        for: 2m
        severity: critical
        summary: Alertmanager is down
        description: Alertmanager instance is not reachable.
        impact: Alerts will not be delivered to notification channels.
        action: Check Alertmanager pod status, logs, and resource usage.

alertmanager:
  enabled: true
  config:
    global:
      resolve_timeout: 5m
    route:
      group_by:
        - alertname
        - namespace
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 3h
      receiver: slack-notifications
    receivers:
      - name: slack-notifications
        slack_configs:
          - channel: "#alerts"
            send_resolved: true
            slack_webhook_url:
              name: alertmanager-slack      
              key: slack-webhook-url        
            title: "{{ .CommonAnnotations.summary }}"
            text: |
              *Severity:* {{ .CommonLabels.severity }}
              *Impact:* {{ .CommonAnnotations.impact }}
              *Action:* {{ .CommonAnnotations.action }}
