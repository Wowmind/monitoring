name: Security Scanning

on:
  workflow_run:
    workflows: ["Continuous Integration"]
    types: [completed]
    branches: 
        - main

  workflow_dispatch:
    inputs:
      scan_level:
        description: 'Scan depth level'
        required: true
        default: 'standard'
        type: choice
        options:
          - standard
          - deep

  schedule:
    - cron: '0 2 * * 1'

env:
  TRIVY_VERSION: 0.48.3
  PYTHON_VERSION: 3.11

jobs:
  # Job 0: Check CI status
  check-ci-status:
    name: Verify CI Status
    runs-on: ubuntu-latest
    outputs:
      should-scan: ${{ steps.check.outputs.scan }}
    steps:
      - name: Check CI conclusion
        id: check
        run: |
          if [[ "${{ github.event.workflow_run.conclusion }}" == "success" ]]; then
            echo "scan=true" >> $GITHUB_OUTPUT
            echo "CI passed, proceeding with security scan"
          else
            echo "scan=false" >> $GITHUB_OUTPUT
            echo "CI failed, skipping security scan"
            exit 0
          fi

  # Job 1: SAST (Bandit)
  sast-scan:
    name: SAST - Bandit Security Scan
    runs-on: ubuntu-latest
    needs: check-ci-status
    if: needs.check-ci-status.outputs.should-scan == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Bandit
        run: pip install bandit[toml] bandit-sarif-formatter

      - name: Run Bandit
        run: |
          bandit -r . -f sarif -o bandit.sarif -x ./tests,./venv || true

      - uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: bandit.sarif
          category: sast-bandit

  # Job 2: Dockerfile Scan
  dockerfile-scan:
    name: Dockerfile Security Scan
    runs-on: ubuntu-latest
    needs: check-ci-status
    if: needs.check-ci-status.outputs.should-scan == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4

      - name: Trivy Dockerfile Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: config
          scan-ref: Dockerfile
          format: sarif
          output: trivy-dockerfile.sarif
          severity: CRITICAL,HIGH,MEDIUM
          exit-code: 0

      - uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-dockerfile.sarif
          category: dockerfile-security

  # Job 3: Helm Chart Scan
  helm-chart-scan:
    name: Helm Chart Security Scan
    runs-on: ubuntu-latest
    needs: check-ci-status
    if: needs.check-ci-status.outputs.should-scan == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4

      - uses: azure/setup-helm@v4
        with:
          version: v3.13.0

      - name: Helm Lint
        run: helm lint helm-chart/ --strict || true

      - name: Trivy Helm Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: config
          scan-ref: helm-chart/
          format: sarif
          output: trivy-helm.sarif
          severity: CRITICAL,HIGH,MEDIUM
          exit-code: 0

      - uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-helm.sarif
          category: helm-security

  # Job 4: Terraform IaC Scan
  terraform-scan:
    name: Terraform IaC Security Scan
    runs-on: ubuntu-latest
    needs: check-ci-status
    if: needs.check-ci-status.outputs.should-scan == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4

      - name: Trivy Terraform Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: config
          scan-ref: terraform/
          format: sarif
          output: trivy-terraform.sarif
          severity: CRITICAL,HIGH,MEDIUM
          exit-code: 0

      - uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-terraform.sarif
          category: terraform-trivy

      - name: Checkov Terraform Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: terraform/
          framework: terraform
          output_format: sarif
          output_file_path: checkov-terraform.sarif
        continue-on-error: true

      - uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov-terraform.sarif
          category: terraform-checkov

  # Job 5: Container Image Scan
  image-scan:
    name: Container Image Scan
    runs-on: ubuntu-latest
    needs: [check-ci-status, dockerfile-scan]
    if: needs.check-ci-status.outputs.should-scan == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - name: Build image
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          push: false
          tags: task-manager-app:security-scan

      - name: Trivy Image Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: task-manager-app:security-scan
          format: sarif
          output: trivy-image.sarif
          severity: CRITICAL,HIGH,MEDIUM
          exit-code: 0

      - uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-image.sarif
          category: image-vulnerabilities

  # Job 6: SBOM
  generate-sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    needs: image-scan
    if: needs.check-ci-status.outputs.should-scan == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4

      - name: Build image
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          push: false
          tags: task-manager-app:sbom

      - name: Generate SBOM
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: task-manager-app:sbom
          format: cyclonedx
          output: sbom-cyclonedx.json

      - uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom-cyclonedx.json
          retention-days: 365

  # Job 7: Security Summary
  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs:
      - sast-scan
      - dockerfile-scan
      - helm-chart-scan
      - terraform-scan
      - image-scan
      - generate-sbom
    if: always()
    steps:
      - name: Summary
        run: |
          echo "# Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Scan | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| SAST (Bandit) | ${{ needs.sast-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dockerfile | ${{ needs.dockerfile-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Helm Chart | ${{ needs.helm-chart-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform IaC | ${{ needs.terraform-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Scan | ${{ needs.image-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SBOM | ${{ needs.generate-sbom.result }} |" >> $GITHUB_STEP_SUMMARY
